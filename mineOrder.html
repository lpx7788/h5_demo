<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-Control" content="no-cache">
	<meta http-equiv="Expires" content="0">

	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="format-detection" content="telephone=no" />
	<title>奥特斯</title>
	<link rel="stylesheet" href="css/swiper-4.3.5.min.css" />
	<link rel="stylesheet" href="css/public.css?v=20180910" />
	<link rel="stylesheet" href="css/shop.css?v=20180910" />
</head>
<body class="hideFoot"> <!-- hideHead hideFoot -->
	<div class="webHead df hao jcb" id="webHead">
		<div class="h-btn h-btn-back" toLocation="back"></div>
		<div class="flex h-txt">我的订单</div>
		<div class="h-btn"></div>
	</div>

	<div class="webBody" id="webBody">
		<div class="defUbeBox">
			<div class="defUbeBox-top df wao hao">
				<div class="vis df hao">
					<div class="flex vi cur" et="商品订单">商品订单</div>
					<div class="flex vi" et="入住订单">入住订单</div>
					<div class="flex vi" et="房车预订">房车预订</div>
				</div>
			</div>
			<div class="defUbeBox-content cur" et="商品订单">
				<div class="defTabBox">
					<div class="defTabBox-top df hao">
						<div class="flex li cur" et="全部">全部</div>
						<div class="flex li" et="待付款">待付款</div>
						<div class="flex li" et="待发货">待发货</div>
						<div class="flex li" et="待收货">待收货</div>
						<div class="flex li" et="已签收">已签收</div>
					</div>
					<div class="defTabBox-content cur" et="全部" id="cat_shop_1_Item"></div>
					<div class="defTabBox-content" et="待付款" id="cat_shop_2_Item"></div>
					<div class="defTabBox-content" et="待发货" id="cat_shop_3_Item"></div>
					<div class="defTabBox-content" et="待收货" id="cat_shop_4_Item"></div>
					<div class="defTabBox-content" et="已签收" id="cat_shop_5_Item"></div>
				</div>
			</div>
			<div class="defUbeBox-content" et="入住订单">
				<div class="defTabBox">
					<div class="defTabBox-top df hao">
						<div class="flex li cur" et="全部">全部</div>
						<div class="flex li" et="待入住">待入住</div>
						<div class="flex li" et="已入住">已入住</div>
					</div>
					<div class="defTabBox-content cur" et="全部" id="cat_house_1_Item"></div>
					<div class="defTabBox-content" et="待入住" id="cat_house_2_Item"></div>
					<div class="defTabBox-content" et="已入住" id="cat_house_3_Item"></div>
				</div>
			</div>
			<div class="defUbeBox-content" et="房车预订">
				<div class="defTabBox">
					<div class="defTabBox-top df hao">
						<div class="flex li cur" et="全部">全部</div>
						<div class="flex li" et="待付款">待付款</div>
						<div class="flex li" et="待使用">待使用</div>
					</div>
					<div class="defTabBox-content cur" et="全部" id="cat_tourCar_1_Item"></div>
					<div class="defTabBox-content" et="待付款" id="cat_tourCar_2_Item"></div>
					<div class="defTabBox-content" et="待使用" id="cat_tourCar_3_Item"></div>
				</div>
			</div>
		</div>
	</div>

	<div class="webFoot df hao jcb" id="webFoot"></div>
</body>
<script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="js/swiper-4.3.5.min.js"></script>
<script type="text/javascript" src="js/public.js?v=20180912"></script>
<script type="text/javascript" src="js/shopOrder.js?v=20180910"></script>
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>
<script type="text/javascript">
	var envType = 1;
	var ua = window.navigator.userAgent.toLowerCase();
    if(ua.match(/MicroMessenger/i) == 'micromessenger'){    //判断是否是微信环境
        //微信环境
        wx.miniProgram.getEnv(function(res) {
            if (res.miniprogram) {
                // 小程序环境下逻辑 
				envType = 2;
            }else {
                //非小程序环境下逻辑
            }
        })
    }else{
          //非微信环境逻辑
    }
	var webType = 'mineOrder';
	// 商品订单
	var catShopArr = [
		// {
		// 	shop: '随行科技',
		// 	state: '待付款',
		// 	list: [
		// 		{ name: 'AILISI 爱丽诗最新款玫瑰补水保湿型面膜', img: 'file/1.jpg', price: 1600, num: 2 },
		// 		{ name: 'AILISI 爱丽诗面包', img: 'file/1.jpg', price: 1600, num: 1 },
		// 	],
		// },
		// {
		// 	shop: '随行科技',
		// 	state: '待发货',
		// 	list: [
		// 		{ name: 'AILISI 爱丽诗最新款', img: 'file/1.jpg', price: 1600, num: 2 },
		// 	],
		// },
		// {
		// 	shop: '随行科技',
		// 	state: '已取消',
		// 	list: [
		// 		{ name: 'AILISI 爱丽诗面包', img: 'file/1.jpg', price: 1600, num: 2 },
		// 	],
		// },
		// {
		// 	shop: '随行科技',
		// 	state: '待收货',
		// 	list: [
		// 		{ name: 'AILISI 爱丽诗面包', img: 'file/1.jpg', price: 1600, num: 2 },
		// 	],
		// },
		// {
		// 	shop: '随行科技',
		// 	state: '交易完成',
		// 	list: [
		// 		{ name: 'AILISI 爱丽诗面包', img: 'file/1.jpg', price: 1600, num: 2 },
		// 	],
		// },
		// {
		// 	shop: '随行科技',
		// 	state: '定金 待付款',
		// 	list: [
		// 		{ name: '权益会员卡', img: 'file/1.jpg', price: 1600, num: 2 },
		// 	],
		// },
		// {
		// 	shop: '随行科技',
		// 	state: '定金 已付款',
		// 	list: [
		// 		{ name: '权益会员卡', img: 'file/1.jpg', price: 1600, num: 2 },
		// 	],
		// },
		// {
		// 	shop: '随行科技',
		// 	state: '尾款 待付款',
		// 	list: [
		// 		{ name: '权益会员卡', img: 'file/1.jpg', price: 1600, num: 2 },
		// 	],
		// },
		// {
		// 	shop: '随行科技',
		// 	state: '权益卡 交易完成',
		// 	list: [
		// 		{ name: '权益会员卡', img: 'file/1.jpg', price: 1600, num: 2 },
		// 	],
		// },
	];
	
	function catShopInit(){
		var html = html2 = html3 = html4 = html5 = '';
		$.each(catShopArr,function(a,b){
			var ph = '';
			var countMoney = 0;
			var countNum = 0;
			$.each(b.list,function(c,d){
				ph += '<div class="order-li-pdli df cf jcb">'+
							'<div class="img"><img src="'+d.img+'" alt=""></div>'+
							'<div class="info df jcb">'+
								'<div class="name flex ov-2d">'+d.name+'</div>'+
								'<div class="remove"></div>'+
							'</div>'+
							'<div class="ps df jcb">'+
								'<div class="tag">#预售</div>'+
								'<div class="price flex">￥'+d.price+'</div>'+
								'<div class="num">x'+d.num+'</div>'+
							'</div>'+
						'</div>';
				countMoney += Number(d.price) * Number(d.num);
				countNum += Number(d.num); 
			})
			var s = returnState(b.orderid,b.state,countNum,countMoney,b.lock_state,b.pay_sn,b.pay_money);
			var lock_state = (b.lock_state==1?'&lock_state=1':'');
			var h = '<div class="order-li" orderState="shop-'+s.type+'" toLocation="shopOrder.html?type='+s.type+'&orderid='+b.orderid+lock_state+'" oid="'+b.orderid+'">'+
						'<div class="order-li-top df hao jcb">'+
							'<div class="shop">'+b.shop+'</div>'+
							'<div class="state">'+b.state+'</div>'+
						'</div>'+
						'<div class="order-li-pdlist">'+ph+'</div>'+
						'<div class="order-li-tool">'+s.toolHtml+'</div>'+
					'</div>';

			if(s.type==1||s.type==6||s.type==7){
				html2 += h;
			}else if(s.type==2){
				html3 += h;
			}else if(s.type==4){
				html4 += h;
			}else if(s.type==5){
				html5 += h;
			}
			html += h;
		})
		$('#cat_shop_1_Item').html(html); // 全部
		$('#cat_shop_2_Item').html(html2); // 待付款
		$('#cat_shop_3_Item').html(html3); // 待发货
		$('#cat_shop_4_Item').html(html4); // 待收货
		$('#cat_shop_5_Item').html(html5); // 已签收

		function returnState(orderId,state,count,money,lock_state,pay_sn,pay_money){
			var type = 1;
			var toolHtml = '';
			if(state=='待付款'){
				type = 1;
				toolHtml = '<div class="line df hao jcb">'+
								'<div class="count">共'+count+'件商品，合计￥'+money+'(含运费0.00)</div>'+
								'<div class="btn" onclick="shopOrderDo(this,\'nowToPay\',{ pay_sn: \''+pay_sn+'\', pay_money: \''+pay_money+'\', pay_type: 4 })">立即付款</div>'+
							'</div>';
			}else if(state=='待发货'){
				type = 2;
				toolHtml = '<div class="line df hao jcb">'+
								'<div class="count">共'+count+'件商品，合计￥'+money+'(含运费0.00)</div>'+
								'<div class="btn" toLocation="orderApplyRefund.html?orderid='+orderId+'" stopLocation="parent">'+(lock_state==1?'取消退款':'申请退款')+'</div>'+
							'</div>';
			}else if(state=='已取消'){
				type = 3;
				toolHtml = '<div class="line df hao jcb">'+
								'<div class="count">共'+count+'件商品，合计￥'+money+'(含运费0.00)</div>'+
							'</div>';
			}else if(state=='待收货'){
				type = 4;
				toolHtml = '<div class="line df hao jcb">'+
								'<div class="count">共'+count+'件商品，合计￥'+money+'(含运费0.00)</div>'+
							'</div>'+
							'<div class="line df hao war">'+
								// '<div class="btn btn-black" onclick="shopOrderDo(this,\'showLogistics\')">查看物流</div>'+
								'<div class="btn" onclick="shopOrderDo(this,\'confirmReceipt\')">确认收货</div>'+
							'</div>';
			}else if(state=='交易完成'){
				type = 5;
				toolHtml = '<div class="line df hao jcb">'+
								'<div class="count">共'+count+'件商品，合计￥'+money+'(含运费0.00)</div>'+
								// '<div class="btn" toLocation="orderApplyRefund.html?orderid='+orderId+'" stopLocation="parent">申请退款</div>'+
							'</div>';
			}else if(state=='定金 待付款'){
				type = 6;
				toolHtml = '<div class="line df hao jcb">'+
								'<div class="count">共'+count+'件商品，实付定金￥'+money+'(含运费0.00)</div>'+
							'</div>'+
							'<div class="line df hao war">'+
								'<div class="btn btn-black" onclick="shopOrderDo(this,\'cancelOrder\')">取消订单</div>'+
								'<div class="btn" onclick="shopOrderDo(this,\'nowToPay\',{ pay_sn: \''+pay_sn+'\', pay_money: \''+pay_money+'\', pay_type: 3 })">立即付款</div>'+
							'</div>';
			}else if(state=='定金 已付款'){
				type = 7;
				toolHtml = '<div class="line df hao jcb">'+
								'<div class="count">共'+count+'件商品，实付￥'+money+'(含运费0.00)</div>'+
								// '<div class="btn">立即付款</div>'+
							'</div>';
			}else if(state=='尾款 待付款'){
				type = 8;
				toolHtml = '<div class="line df hao jcb">'+
								'<div class="count">共'+count+'件商品，实付￥'+money+'(含运费0.00)</div>'+
								'<div class="btn" onclick="shopOrderDo(this,\'nowToPay\',{ pay_sn: \''+pay_sn+'\', pay_money: \''+pay_money+'\', pay_type: 3 })">立即付款</div>'+
							'</div>';
			}else if(state=='权益卡 交易完成'){
				type = 9;
				toolHtml = '<div class="line df hao jcb">'+
								'<div class="count">共'+count+'件商品，合计￥'+money+'(含运费0.00)</div>'+
								// '<div class="btn" toLocation="orderApplyRefund.html?orderid='+orderId+'" stopLocation="parent">申请退款</div>'+
							'</div>';
			}
			return { type: type, toolHtml: toolHtml };
		}
	}

	var nowPage = 1;
	var pageNum = 1;
	reloadShopOrderData();
	function reloadShopOrderData () {
		nowPage = 1;
		ajax_shopOrder('state_new');
		ajax_shopOrder('state_send');
		ajax_shopOrder('state_notakes');
		ajax_shopOrder('state_noeval');
	}
	// 确认收货
	function collect_goods(oid){
		ajax({
			url: '@server/act=member_order&op=order_receive',
			param:{
				order_id: oid,
				key: userLoginToken,
			},
			call: function(r){
			// cs(r);
				if(r==1){
					alerts({
						txt:"已确认收货！",
						type:"success",
						click:function(){
							if(webType=='mineOrder'){
								reloadShopOrderData();
							}else{
								window.history.go(-1);
							}
						}
					});
				}
			}
		});
	}
	function ajax_shopOrder(s){
		ajax({
			url: '@server/act=member_order&op=order_list',
			param: {
				page: pageNum,
				curpage: nowPage,
				state_type:s,
				key: userLoginToken,
			},
			call: function(r){
				// cs(r);
				r.order_group_list.forEach(function(item,index){
					item.order_list.forEach(function(item2,index2){
						var list = [], state = '';
						item2.extend_order_goods.forEach(function(item3,index3){
							list.push({ name: item3.goods_name, img: item3.goods_image_url, price: item3.goods_price, num: item3.goods_num },)
						});
						switch(s){
							case "state_new":
								state='待付款';
								break;
							case "state_send":
								state='待发货';
								break;
							case "state_notakes":
								state='待收货';
								break;
							case "state_noeval":
								state='交易完成';
								break;
						}
						catShopArr.push({
							shop: item2.store_name,
							state: state,
							orderid: item2.order_id,
							lock_state: item2.lock_state,
							list: list,
							pay_sn: item2.pay_sn,
							pay_money: item2.order_amount,
						})
					})
				})
				catShopInit();
			}
		});
	}

	// bindScrollCall('#webBody .defUbeBox-content[et="商品订单"] .defTabBox-content[et="待付款"]',150,function(s){
	// 	nowPage++;
	// 	ajax_shopOrder(s);
	// });

	function shopOrderDo(obj,name,json){
		event.stopPropagation();
		var oid = $(obj).closest('.order-li').attr('oid');
		if(name=='nowToPay'){ // 立即付款
			if( envType == '1' ) {
				memberBuy(json.pay_sn, json.pay_money, json.pay_type, envType);
			}else if (envType == '2') {
				wx.miniProgram.navigateTo({
					url: "/pages/pay/pay?type=0&pay_sn=" + json.pay_sn + "&key=" + userLoginToken + "&url=" + window.location.href,
					success: function(){
						console.log('success')
					},
					fail: function(){
						console.log('fail');
					},
					complete:function(res){
						console.log(res);
					}
				});
			}
			
		}else if(name=='showLogistics'){ // 查看物流
		}else if(name=='confirmReceipt'){ // 确认收货
			collect_goods(oid);
		}else if(name=='cancelOrder'){ // 取消订单
			orderCancel(oid);
		}
		return false;
	}


	// 入住订单
	var catHouseArr = [
		// { name: '欧式烂漫双人房', img: 'file/1.jpg', price: 1600, state: '待付款', num: 2, date: '2018/07/18至07/20' },
		// { name: '欧式烂漫双人房', img: 'file/1.jpg', price: 1600, state: '已付款', num: 2, date: '2018/07/18至07/20' },
		// { name: '欧式烂漫双人房', img: 'file/1.jpg', price: 1600, state: '待入住', num: 2, date: '2018/07/18至07/20' },
		// { name: '欧式烂漫双人房', img: 'file/1.jpg', price: 1600, state: '已入住', num: 2, date: '2018/07/18至07/20' },
		// { name: '欧式烂漫双人房', img: 'file/1.jpg', price: 1600, state: '已取消', num: 2, date: '2018/07/18至07/20' },
		// { name: '欧式烂漫双人房', img: 'file/1.jpg', price: 1600, state: '已完成', num: 2, date: '2018/07/18至07/20' },
	];
	catHouseInit();
	function catHouseInit(){
		var html = html2 = html3 = '';
		$.each(catHouseArr,function(a,b){
			var s = returnState(b.state);
			var h = '<div class="order-li" orderState="house-'+s.type+'">'+
						'<div class="order-li-pdlist">'+
							'<div class="order-li-pdli df cf jcb">'+
								'<div class="img"><img src="'+b.img+'" alt=""></div>'+
								'<div class="info df jcb">'+
									'<div class="name flex ov-2d">'+b.name+'</div>'+
									'<div class="state2">'+b.state+'</div>'+
								'</div>'+
								'<div class="ps df jcb">'+
									'<div class="date">'+b.date+'</div>'+
									'<div class="price flex">￥'+b.price+'.00</div>'+
									'<div class="num">x'+b.num+'</div>'+
								'</div>'+
							'</div>'+
						'</div>'+
						'<div class="order-li-tool">'+s.toolHtml+'</div>'+
					'</div>';

			if(s.type==3){
				html2 += h;
			}else if(s.type==4){
				html3 += h;
			}
			html += h;
		})
		$('#cat_house_1_Item').html(html); // 全部
		$('#cat_house_2_Item').html(html2); // 待入住
		$('#cat_house_3_Item').html(html3); // 已入住

		function returnState(state){
			var type = 1;
			var toolHtml = '';
			if(state=='待付款'){
				type = 1;
				toolHtml = '<div class="line df hao war">'+
								'<div class="btn btn-gray">取消订单</div>'+
								'<div class="btn" toLocation="reserveHouseTake.html" stopLocation="parent">立即付款</div>'+
							'</div>';
			}else if(state=='已付款'){
				type = 2;
				toolHtml = '<div class="line df hao war">'+
								'<div class="btn btn-gray">取消订单</div>'+
							'</div>';
			}else if(state=='待入住'){
				type = 3;
				toolHtml = '<div class="line df hao war">'+
								'<div class="btn btn-gray">取消订单</div>'+
								'<div class="btn btn-orange">开锁码</div>'+
							'</div>';
			}else if(state=='已入住'){
				type = 4;
				toolHtml = '<div class="line df hao war">'+
								'<div class="btn" toLocation="reserveHouseTake.html" stopLocation="parent">续住</div>'+
								'<div class="btn btn-orange">开锁码</div>'+
							'</div>';
			}else if(state=='已取消'){
				type = 5;
				toolHtml = '<div class="line df hao war">'+
								'<div class="btn" toLocation="reserveHouseTake.html" stopLocation="parent">再次预定</div>'+
							'</div>';
			}else if(state=='已完成'){
				type = 6;
				toolHtml = '<div class="line df hao war">'+
								'<div class="btn" toLocation="reserveHouseTake.html" stopLocation="parent">再次预定</div>'+
							'</div>';
			}
			return { type: type, toolHtml: toolHtml };
		}
	}

	// 房车预订
	var catTourCarArr = [
		// { name: '大通C A类房车 大通C A类房车', img: 'file/1.jpg', price: 1600, state: '待付款', date: '2018/07/18至2018/07/20' },
		// { name: '大通C A类房车 大通C A类房车', img: 'file/1.jpg', price: 1600, state: '已取消', date: '2018/07/18至2018/07/20' },
		// { name: '大通C A类房车 大通C A类房车', img: 'file/1.jpg', price: 1600, state: '待使用', date: '2018/07/18至2018/07/20' },
		// { name: '大通C A类房车 大通C A类房车', img: 'file/1.jpg', price: 1600, state: '已完成', date: '2018/07/18至2018/07/20' },
	];
	catTourCarInit();
	function catTourCarInit(){
		var html = html2 = html3 = '';
		$.each(catTourCarArr,function(a,b){
			var s = returnState(b.state);
			var h = '<div class="order-li" orderState="tourCar-'+s.type+'">'+
						'<div class="order-li-pdlist">'+
							'<div class="order-li-pdli df cf jcb">'+
								'<div class="img"><img src="'+b.img+'" alt=""></div>'+
								'<div class="info df jcb">'+
									'<div class="name flex ov-2d">'+b.name+'</div>'+
									'<div class="state2">'+b.state+'</div>'+
									'<div class="remove"></div>'+
								'</div>'+
								'<div class="ps df jcb">'+
									'<div class="date">'+b.date+'</div>'+
									'<div class="price flex">￥'+b.price+'.00</div>'+
								'</div>'+
							'</div>'+
						'</div>'+
						'<div class="order-li-tool">'+s.toolHtml+'</div>'+
					'</div>';

			if(s.type==1){
				html2 += h;
			}else if(s.type==3){
				html3 += h;
			}
			html += h;
		})
		$('#cat_tourCar_1_Item').html(html); // 全部
		$('#cat_tourCar_2_Item').html(html2); // 待付款
		$('#cat_tourCar_3_Item').html(html3); // 待使用

		function returnState(state){
			var type = 1;
			var toolHtml = '';
			if(state=='待付款'){
				type = 1;
				toolHtml = '<div class="line df hao war">'+
								'<div class="btn" toLocation="tourCarOrder.html" stopLocation="parent">立即付款</div>'+
							'</div>';
			}else if(state=='已取消'){
				type = 2;
				toolHtml = '<div class="line df hao war">'+
								'<div class="btn" toLocation="tourCarOrder.html" stopLocation="parent">再次预定</div>'+
							'</div>';
			}else if(state=='待使用'){
				type = 3;
				toolHtml = '<div class="line df hao war">'+
								'<div class="btn" toLocation="tourCarOrder.html" stopLocation="parent">续租</div>'+
							'</div>';
			}else if(state=='已完成'){
				type = 4;
				toolHtml = '<div class="line df hao war">'+
								'<div class="btn" toLocation="tourCarOrder.html" stopLocation="parent">再次预定</div>'+
							'</div>';
			}
			return { type: type, toolHtml: toolHtml };
		}
	}
</script>
</html>